{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Lista de Convênios Emitidos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Lista de Convênios Emitidos</h1>
    <a href="{% url 'convenio_emissao_create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Convênio Emitido
    </a>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Convênios Emitidos</h6>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                {# Updated placeholder for search #}
                <input type="text" id="searchInputConvenioEmissao" class="form-control" placeholder="Buscar por CPF, Cliente, Convênio ou Mês" value="{{ search|default_if_none:'' }}">
            </div>
            {# NOVO FILTRO DE STATUS AQUI - Note: ConvenioEmissao model does not have 'cancelado' directly #}
            {# This filter will be less useful unless you filter by related Cliente/Convenio status #}
            <div class="col-md-3">
                <select id="statusFilterConvenioEmissao" class="form-select">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Todos os Status</option>
                    {# If filtering by related Cliente's cancelado status, adjust values #}
                    {# <option value="ativo" {% if status_filter == 'ativo' %}selected{% endif %}>Ativos (Cliente)</option> #}
                    {# <option value="cancelado" {% if status_filter == 'cancelado' %}selected{% endif %}>Cancelados (Cliente)</option> #}
                    {# Keeping 'false'/'true' for now, assuming a future 'cancelado' field on ConvenioEmissao or for consistency #}
                    <option value="false" {% if status_filter == 'false' %}selected{% endif %}>Ativos</option>
                    <option value="true" {% if status_filter == 'true' %}selected{% endif %}>Cancelados</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="perPageSelectConvenioEmissao" class="form-select">
                    <option value="5" {% if per_page == 5 %}selected{% endif %}>5 por página</option>
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20 por página</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 por página</option>
                </select>
            </div>
        </div>
        {# Corrected ID for the table container #}
        <div class="table-responsive" id="convenioEmissaoTableContainer">
            {% include 'core/convenio_emissao_table_partial.html' %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Corrected IDs for elements
        const searchInput = document.getElementById('searchInputConvenioEmissao');
        const statusFilter = document.getElementById('statusFilterConvenioEmissao');
        const perPageSelect = document.getElementById('perPageSelectConvenioEmissao');
        const convenioEmissaoTableContainer = document.getElementById('convenioEmissaoTableContainer');
        let debounceTimeout;

        function fetchConvenioEmissoes(params = {}) { // Corrected function name
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const url = new URL(window.location.origin + window.location.pathname);
                const currentParams = new URLSearchParams(window.location.search);

                currentParams.forEach((value, key) => {
                    if (!(key in params)) {
                        url.searchParams.set(key, value);
                    }
                });

                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));

                url.searchParams.forEach((value, key) => {
                    if (value === '' || (key === 'status' && value === 'all')) {
                        url.searchParams.delete(key);
                    }
                });

                console.log("Fetching ConvenioEmissao URL:", url.toString());

                fetch(url.toString(), {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (convenioEmissaoTableContainer) {
                        convenioEmissaoTableContainer.innerHTML = data.html;
                        window.history.pushState({}, '', url);
                    } else {
                        console.error("Element with ID 'convenioEmissaoTableContainer' not found.");
                    }
                })
                .catch(error => console.error('Erro ao carregar Emissões de Convênio:', error)); // Corrected error message
            }, 300);
        }

        // Add event listeners, corrected function calls
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                fetchConvenioEmissoes({
                    search: this.value,
                    status: statusFilter ? statusFilter.value : 'all',
                    per_page: perPageSelect ? perPageSelect.value : 10,
                    page: 1
                });
            });
        }
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                fetchConvenioEmissoes({
                    search: searchInput ? searchInput.value : '',
                    status: this.value,
                    per_page: perPageSelect ? perPageSelect.value : 10,
                    page: 1
                });
            });
        }
        if (perPageSelect) {
            perPageSelect.addEventListener('change', function() {
                fetchConvenioEmissoes({
                    search: searchInput ? searchInput.value : '',
                    status: statusFilter ? statusFilter.value : 'all',
                    per_page: this.value,
                    page: 1
                });
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.sort-link, .page-link')) {
                e.preventDefault();

                const currentSearch = searchInput ? searchInput.value : '';
                const currentStatus = statusFilter ? statusFilter.value : 'all';
                const currentPerPage = perPageSelect ? perPageSelect.value : 10;

                const url = new URL(e.target.href);
                const params = Object.fromEntries(url.searchParams.entries());

                if (currentSearch) params.search = currentSearch;
                if (currentStatus && currentStatus !== 'all') params.status = currentStatus;
                if (currentPerPage) params.per_page = currentPerPage;

                fetchConvenioEmissoes(params); // Corrected function call
            }
        });

        // Define the initial value of selects based on Django context
        const initialPerPage = '{{ per_page }}';
        if (perPageSelect && initialPerPage) {
            perPageSelect.value = initialPerPage;
        }
        const initialStatus = '{{ status_filter }}';
        if (statusFilter && initialStatus) {
            if (initialStatus === 'true' || initialStatus === 'false') {
                statusFilter.value = initialStatus;
            } else {
                statusFilter.value = 'all';
            }
        }
    });
</script>
{% endblock %}
{% endblock %}