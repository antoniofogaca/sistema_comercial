{# core/templates/core/convenio_emissao_form.html #}

{% extends 'core/base.html' %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{{ title }}</h6>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <h5 class="text-primary">Dados da Emissão</h5>
            </div>

            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="{{ form.CPF.id_for_label }}" class="form-label">CPF/CNPJ do Cliente<span class="text-danger">*</span></label>
                    {% render_field form.CPF class="form-control" placeholder="Digite o CPF/CNPJ" %}
                    <small class="form-text text-muted">Digite o CPF/CNPJ do cliente para buscar seus dados.</small>
                    {% if form.CPF.errors %}
                        {% for error in form.CPF.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                {% render_field form.ID_CLIENTE type="hidden" %}

                <div class="col-md-6 mb-3">
                    <label for="id_nome_cliente_exibicao" class="form-label">Nome do Cliente</label>
                    <input type="text" id="id_nome_cliente_exibicao" class="form-control" readonly placeholder="Preenchido automaticamente">
                </div>

                <div class="col-md-2 mb-3">
                    <label for="{{ form.SALDO.id_for_label }}" class="form-label">Saldo Disponível</label>
                    {% render_field form.SALDO class="form-control" readonly="readonly" placeholder="R$ 0,00" %}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.MES_REFERENCIA.id_for_label }}" class="form-label">Mês de Referência<span class="text-danger">*</span></label>
                    {% render_field form.MES_REFERENCIA class="form-control" placeholder="MM/AAAA" %}
                </div>
            </div>

            <hr>
            <div class="mb-4 mt-4">
                <h5 class="text-primary">Detalhes do Convênio</h5>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.ID_CONVENIO.id_for_label }}" class="form-label">Convênio<span class="text-danger">*</span></label>
                    {% render_field form.ID_CONVENIO class="form-control" %}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.QTD_PARCELA.id_for_label }}" class="form-label">Quantidade de Parcelas</label>
                    {% render_field form.QTD_PARCELA class="form-control" readonly="readonly" placeholder="Auto" %}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="num_parcelas_solicitada" class="form-label">Nº Parcelas Solicitada<span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="num_parcelas_solicitada" min="1" placeholder="Ex: 3">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.VALOR.id_for_label }}" class="form-label">Valor Solicitado<span class="text-danger">*</span></label>
                    {% render_field form.VALOR class="form-control" placeholder="0,00" %}
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <div class="d-flex w-100">
                        <button type="button" class="btn btn-info w-50 me-1" id="btnGerarParcelas">Gerar Parcelas</button>
                        <button type="button" class="btn btn-secondary w-50" id="btnLimparParcelas">Limpar Parcelas</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="{{ form.DATA_TRANSACAO.id_for_label }}" class="form-label">Data da Transação<span class="text-danger">*</span></label>
                    {% render_field form.DATA_TRANSACAO class="form-control" %}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="{{ form.HORA_TRANSACAO.id_for_label }}" class="form-label">Hora da Transação<span class="text-danger">*</span></label>
                    {% render_field form.HORA_TRANSACAO class="form-control" %}
                </div>
            </div>

            <hr>
            <div class="mb-4 mt-4">
                <h5 class="text-primary">Detalhes das Parcelas Geradas</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered" id="tabelaParcelasGeradas">
                    <thead>
                        <tr>
                            <th>Nº Parcela</th>
                            <th>Valor Parcela</th>
                            <th>Data Vencimento (simulado)</th>
                            <th>Data Emissão</th>
                        </tr>
                    </thead>
                    <tbody id="parcelasContainer">
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary me-2" id="saveButton">Salvar</button>
                <a href="{% url 'core:convenio_emissao_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ======== CLIENTE ========
    const cpfInput = document.querySelector('input[name="CPF"]');
    const idClienteInput = document.querySelector('input[name="ID_CLIENTE"]');
    const nomeClienteInput = document.getElementById('id_nome_cliente_exibicao');
    const saldoInput = document.querySelector('input[name="SALDO"]');
    let lastSearchedCpf = '';

    function limparCamposCliente() {
        idClienteInput.value = '';
        nomeClienteInput.value = '';
        saldoInput.value = '';
    }

    async function buscarClientePorCpf(cpf) {
        try {
            const response = await fetch(`/api/clientes/search_by_cpf/?cpf=${encodeURIComponent(cpf)}`);
            if (!response.ok) {
                limparCamposCliente();
                return;
            }
            const data = await response.json();
            idClienteInput.value = data.id || '';
            nomeClienteInput.value = data.nome_completo || '';
            saldoInput.value = data.saldo || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            limparCamposCliente();
        }
    }

    cpfInput.addEventListener('input', function () {
        const cpf = cpfInput.value.replace(/\D/g, '');
        if (cpf.length === 11 && cpf !== lastSearchedCpf) {
            lastSearchedCpf = cpf;
            buscarClientePorCpf(cpf);
        }
        if (cpf.length < 11) {
            limparCamposCliente();
            lastSearchedCpf = '';
        }
    });

    // ======== CONVENIO ========
    const convenioSelect = document.getElementById('{{ form.ID_CONVENIO.id_for_label }}');
    const qtdParcelaInput = document.getElementById('{{ form.QTD_PARCELA.id_for_label }}');

    async function buscarConvenioDetails(idConvenio) {
        try {
            const response = await fetch(`/api/convenios/get_details/?id=${encodeURIComponent(idConvenio)}`);
            if (!response.ok) {
                qtdParcelaInput.value = '';
                return;
            }
            const data = await response.json();
            qtdParcelaInput.value = data.qtd_parc_permi || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            qtdParcelaInput.value = '';
        }
    }

    convenioSelect.addEventListener('change', function () {
        const idConvenio = convenioSelect.value;
        if (idConvenio) {
            buscarConvenioDetails(idConvenio);
        } else {
            qtdParcelaInput.value = '';
        }
    });

    // ======== MES_REFERENCIA COM CURSOR NO FINAL ========
    const mesRefInput = document.querySelector('input[name="MES_REFERENCIA"]');

    function formatarMesReferencia(valor) {
        const numeros = valor.replace(/\D/g, '').slice(0, 6);
        if (numeros.length <= 2) return numeros;
        return numeros.slice(0,2) + '/' + numeros.slice(2,6);
    }

    if (mesRefInput) {
        mesRefInput.addEventListener('input', function () {
            const valorFormatado = formatarMesReferencia(mesRefInput.value);
            mesRefInput.value = valorFormatado;
            mesRefInput.setSelectionRange(mesRefInput.value.length, mesRefInput.value.length);
        });
        mesRefInput.value = formatarMesReferencia(mesRefInput.value);
    }

    // ======== GERAR PARCELAS ========
    const btnGerar = document.getElementById('btnGerarParcelas');
    const btnLimpar = document.getElementById('btnLimparParcelas');
    const inputNumParcelas = document.getElementById('num_parcelas_solicitada');
    const inputValor = document.getElementById('{{ form.VALOR.id_for_label }}');
    const container = document.getElementById('parcelasContainer');
    const qtdParcelaDisponivel = document.getElementById('{{ form.QTD_PARCELA.id_for_label }}');
    const saldoDisponivelInput = document.getElementById('{{ form.SALDO.id_for_label }}');

    btnGerar.addEventListener('click', function () {
        const totalParcelas = parseInt(inputNumParcelas.value);
        const valorTotal = parseFloat(inputValor.value.replace(',', '.'));
        const mesReferencia = mesRefInput.value.trim();
        const qtdPermitida = parseInt(qtdParcelaDisponivel.value);
        const saldoDisponivel = parseFloat(saldoDisponivelInput.value.replace(',', '.'));

        container.innerHTML = '';

        if (!mesReferencia.match(/^\d{2}\/\d{4}$/)) {
            alert('Informe o Mês/Ano de Referência no formato MM/AAAA.');
            return;
        }

        if (isNaN(totalParcelas) || totalParcelas < 1) {
            alert('Número de parcelas solicitadas deve ser no mínimo 1.');
            return;
        }

        if (isNaN(qtdPermitida) || totalParcelas > qtdPermitida) {
            alert(`Número de parcelas solicitadas não pode ser maior que a quantidade permitida (${qtdPermitida}).`);
            return;
        }

        if (isNaN(valorTotal) || valorTotal <= 0) {
            alert('Valor solicitado deve ser maior que 0.');
            return;
        }

        if (!isNaN(saldoDisponivel) && valorTotal > saldoDisponivel) {
            alert('Valor solicitado não pode ser maior que o saldo disponível.');
            return;
        }

        const [mesRef, anoRef] = mesReferencia.split('/').map(Number);
        const valorParcela = (valorTotal / totalParcelas).toFixed(2);
        const dataEmissao = new Date().toLocaleDateString('pt-BR');

        for (let i = 0; i < totalParcelas; i++) {
            const vencimento = new Date(anoRef, mesRef, 21);
            vencimento.setMonth(vencimento.getMonth() + i);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>R$ ${valorParcela.replace('.', ',')}</td>
                <td>${vencimento.toLocaleDateString('pt-BR')}</td>
                <td>${dataEmissao}</td>
            `;
            container.appendChild(row);
        }
    });

    btnLimpar.addEventListener('click', function () {
        container.innerHTML = '';
    });
});
</script>
{% endblock %}