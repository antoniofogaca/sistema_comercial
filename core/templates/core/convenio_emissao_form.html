{# core/templates/core/convenio_emissao_form.html #}

{% extends 'core/base.html' %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{{ title }}</h6>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <h5 class="text-primary">Dados da Emissão</h5>
            </div>

            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="{{ form.CPF.id_for_label }}" class="form-label">CPF/CNPJ do Cliente<span class="text-danger">*</span></label>
                    {% render_field form.CPF class="form-control" %}
                    {% if form.CPF.errors %}
                        {% for error in form.CPF.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                {% render_field form.ID_CLIENTE type="hidden" %}

                <div class="col-md-6 mb-3">
                    <label for="id_nome_cliente_exibicao" class="form-label">Nome</label>
                    <input type="text" id="id_nome_cliente_exibicao" class="form-control" readonly placeholder="Preenchido automaticamente">
                </div>

                <div class="col-md-2 mb-3">
                    <label for="{{ form.SALDO.id_for_label }}" class="form-label">Saldo</label>
                    {% render_field form.SALDO class="form-control" readonly="readonly" placeholder="R$ 0,00" %}
                </div>
            </div>

            <hr>
            <div class="mb-4 mt-4">
                <h5 class="text-primary">Detalhes do Convênio</h5>
            </div>

            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="{{ form.ID_CONVENIO.id_for_label }}" class="form-label">Convênio<span class="text-danger">*</span></label>
                    {% render_field form.ID_CONVENIO class="form-control" %}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.QTD_PARCELA.id_for_label }}" class="form-label">Quantidade de Parcelas</label>
                    {% render_field form.QTD_PARCELA class="form-control" readonly="readonly" placeholder="Auto" %}
                </div>

            </div>
            <hr>
            <div class="mb-4 mt-4">
                <h5 class="text-primary">Solicitar Requisição</h5>
            </div>
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="{{ form.MES_REFERENCIA.id_for_label }}" class="form-label">Mês de Referência<span class="text-danger">*</span></label>
                    {% render_field form.MES_REFERENCIA class="form-control" placeholder="MM/AAAA" %}
                </div>
                <div class="col-md-2 mb-3">
                    <label for="num_parcelas_solicitada" class="form-label">Nº Parcelas Solicitada<span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="num_parcelas_solicitada" min="1" placeholder="Ex: 3">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="{{ form.VALOR.id_for_label }}" class="form-label">Valor Solicitado<span class="text-danger">*</span></label>
                    {% render_field form.VALOR class="form-control" placeholder="0,00" %}
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <div class="d-flex w-100">
                        <button type="button" class="btn btn-info w-50 me-1" id="btnGerarParcelas">Gerar Parcelas</button>
                        <button type="button" class="btn btn-secondary w-50" id="btnLimparParcelas">Limpar Parcelas</button>
                    </div>
                </div>
            </div>

<!--            <div class="row">-->
<!--                <div class="col-md-3 mb-3">-->
<!--                    <label for="{{ form.DATA_TRANSACAO.id_for_label }}" class="form-label">Data da Transação<span class="text-danger">*</span></label>-->
<!--                    {% render_field form.DATA_TRANSACAO class="form-control" %}-->
<!--                </div>-->
<!--                <div class="col-md-3 mb-3">-->
<!--                    <label for="{{ form.HORA_TRANSACAO.id_for_label }}" class="form-label">Hora da Transação<span class="text-danger">*</span></label>-->
<!--                    {% render_field form.HORA_TRANSACAO class="form-control" %}-->
<!--                </div>-->
<!--           </div>-->



            <hr>
            <div class="mb-4 mt-4">
                <h5 class="text-primary">Detalhes das Parcelas Geradas</h5>
            </div>
           <div class="table-responsive">
    <table class="table table-bordered table-hover table-striped shadow-sm rounded bg-dark text-light" id="tabelaParcelasGeradas" style="border-radius: 10px; overflow: hidden;">
        <thead style="background: linear-gradient(to right, #37474f, #263238); color: #ffffff;">
            <tr>
                <th>Nº Parcela</th>
                <th>Valor Parcela</th>
                <th>Data Vencimento (simulado)</th>
                <th>Data Emissão</th>
            </tr>
        </thead>
        <tbody id="parcelasContainer">
            {% if parcelas %}
                {% for parcela in parcelas %}
                    <tr>
                        <td>{{ parcela.N_PARCELA }}</td>
                        <td>R$ {{ parcela.VALOR_PARCELA|floatformat:2 }}</td>
                        <td>{{ parcela.DATA_VENCIMENTO|date:"d/m/Y" }}</td>
                        <td>{{ parcela.DATA_EMISSAO|date:"d/m/Y H:i" }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary me-2" id="saveButton">Salvar</button>
                <a href="{% url 'core:convenio_emissao_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ======== CLIENTE ========
    const cpfInput = document.querySelector('input[name="CPF"]');
    const idClienteInput = document.querySelector('input[name="ID_CLIENTE"]');
    const nomeClienteInput = document.getElementById('id_nome_cliente_exibicao');
    const saldoInput = document.querySelector('input[name="SALDO"]');
    let lastSearchedCpf = '';

    function limparCamposCliente() {
        idClienteInput.value = '';
        nomeClienteInput.value = '';
        saldoInput.value = '';
    }

    async function buscarClientePorCpf(cpf) {
        try {
            const response = await fetch(`/api/clientes/search_by_cpf/?cpf=${encodeURIComponent(cpf)}`);
            if (!response.ok) {
                limparCamposCliente();
                return;
            }
            const data = await response.json();
            idClienteInput.value = data.id || '';
            nomeClienteInput.value = data.nome_completo || '';
            saldoInput.value = data.saldo || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            limparCamposCliente();
        }
    }

    cpfInput.addEventListener('input', function () {
        const cpf = cpfInput.value.replace(/\D/g, '');
        if (cpf.length === 11 && cpf !== lastSearchedCpf) {
            lastSearchedCpf = cpf;
            buscarClientePorCpf(cpf);
        }
        if (cpf.length < 11) {
            limparCamposCliente();
            lastSearchedCpf = '';
        }
    });

    // ======== CONVENIO ========
    const convenioSelect = document.getElementById('{{ form.ID_CONVENIO.id_for_label }}');
    const qtdParcelaInput = document.getElementById('{{ form.QTD_PARCELA.id_for_label }}');

    async function buscarConvenioDetails(idConvenio) {
        try {
            const response = await fetch(`/api/convenios/get_details/?id=${encodeURIComponent(idConvenio)}`);
            if (!response.ok) {
                qtdParcelaInput.value = '';
                return;
            }
            const data = await response.json();
            qtdParcelaInput.value = data.qtd_parc_permi || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            qtdParcelaInput.value = '';
        }
    }

    convenioSelect.addEventListener('change', function () {
        const idConvenio = convenioSelect.value;
        if (idConvenio) {
            buscarConvenioDetails(idConvenio);
        } else {
            qtdParcelaInput.value = '';
        }
    });

    // ======== MES_REFERENCIA COM CURSOR NO FINAL ========
    const mesRefInput = document.querySelector('input[name="MES_REFERENCIA"]');

    function formatarMesReferencia(valor) {
        const numeros = valor.replace(/\D/g, '').slice(0, 6);
        if (numeros.length <= 2) return numeros;
        return numeros.slice(0,2) + '/' + numeros.slice(2,6);
    }

    if (mesRefInput) {
        mesRefInput.addEventListener('input', function () {
            const valorFormatado = formatarMesReferencia(mesRefInput.value);
            mesRefInput.value = valorFormatado;
            mesRefInput.setSelectionRange(mesRefInput.value.length, mesRefInput.value.length);
        });
        mesRefInput.value = formatarMesReferencia(mesRefInput.value);
    }

    // ======== GERAR PARCELAS ========
    const btnGerar = document.getElementById('btnGerarParcelas');
    const btnLimpar = document.getElementById('btnLimparParcelas');
    const inputNumParcelas = document.getElementById('num_parcelas_solicitada');
    const inputValor = document.getElementById('{{ form.VALOR.id_for_label }}');
    const container = document.getElementById('parcelasContainer');
    const qtdParcelaDisponivel = document.getElementById('{{ form.QTD_PARCELA.id_for_label }}');
    const saldoDisponivelInput = document.getElementById('{{ form.SALDO.id_for_label }}');

    btnGerar.addEventListener('click', function () {
        const totalParcelas = parseInt(inputNumParcelas.value);
        const valorTotal = parseFloat(inputValor.value.replace(',', '.'));
        const mesReferencia = mesRefInput.value.trim();
        const qtdPermitida = parseInt(qtdParcelaDisponivel.value);
        const saldoDisponivel = parseFloat(saldoDisponivelInput.value.replace(',', '.'));

        container.innerHTML = '';

        if (!mesReferencia.match(/^\d{2}\/\d{4}$/)) {
            alert('Informe o Mês/Ano de Referência no formato MM/AAAA.');
            return;
        }

        if (isNaN(totalParcelas) || totalParcelas < 1) {
            alert('Número de parcelas solicitadas deve ser no mínimo 1.');
            return;
        }

        if (isNaN(qtdPermitida) || totalParcelas > qtdPermitida) {
            alert(`Número de parcelas solicitadas não pode ser maior que a quantidade permitida (${qtdPermitida}).`);
            return;
        }

        if (isNaN(valorTotal) || valorTotal <= 0) {
            alert('Valor solicitado deve ser maior que 0.');
            return;
        }

        if (!isNaN(saldoDisponivel) && valorTotal > saldoDisponivel) {
            alert('Valor solicitado não pode ser maior que o saldo disponível.');
            return;
        }

        const [mesRefNum, anoRefNum] = mesReferencia.split('/').map(Number);
        const valorParcela = (valorTotal / totalParcelas).toFixed(2);
        const now = new Date();
        const dataEmissaoString = now.toLocaleDateString('pt-BR');
        const horaEmissaoString = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        const dataHoraEmissaoCompleta = `${dataEmissaoString} ${horaEmissaoString}`;


        console.log('--- Início da Geração de Parcelas (Frontend) ---');
        for (let i = 0; i < totalParcelas; i++) {
            const vencimento = new Date(anoRefNum, mesRefNum - 1, 21);
            vencimento.setMonth(vencimento.getMonth() + i + 1);

            const diaVenc = String(vencimento.getDate()).padStart(2, '0');
            const mesVenc = String(vencimento.getMonth() + 1).padStart(2, '0');
            const anoVenc = vencimento.getFullYear();
            const dataVencimentoFormatada = `${diaVenc}/${mesVenc}/${anoVenc}`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>R$ ${valorParcela.replace('.', ',')}</td>
                <td>${dataVencimentoFormatada}</td>
                <td>${dataHoraEmissaoCompleta}</td>
            `;
            container.appendChild(row);

            console.log(`  Gerada Parcela ${i + 1}: Valor: R$ ${valorParcela.replace('.', ',')}, Vencimento: ${dataVencimentoFormatada}, Emissão: ${dataHoraEmissaoCompleta}`);
        }
        console.log('--- Fim da Geração de Parcelas (Frontend) ---');
    });

    // Adiciona inputs ocultos para cada parcela ao submeter o formulário
    document.getElementById('saveButton').addEventListener('click', function (event) {
        const form = this.closest('form');
        const linhas = document.querySelectorAll('#parcelasContainer tr');

        form.querySelectorAll('input[name^="parcela_"]').forEach(el => el.remove());

        console.log('--- Preparando Dados das Parcelas para Envio (Frontend) ---');
        linhas.forEach((linha, index) => {
            const numero = linha.cells[0].innerText.trim();
            const valorDisplay = linha.cells[1].innerText.replace('R$', '').trim();
            const valorParaBackend = valorDisplay.replace(',', '.');
            const vencimento = linha.cells[2].innerText.trim();
            const emissaoCompleta = linha.cells[3].innerText.trim();

            console.log(`  Anexando Parcela ${numero}: Número=${numero}, Valor=${valorParaBackend}, Vencimento=${vencimento}, Emissao=${emissaoCompleta}`);

            const inputNumero = document.createElement('input');
            inputNumero.type = 'hidden';
            inputNumero.name = `parcela_${numero}_numero`;
            inputNumero.value = numero;

            const inputValor = document.createElement('input');
            inputValor.type = 'hidden';
            inputValor.name = `parcela_${numero}_valor`;
            inputValor.value = valorParaBackend;

            const inputVencimento = document.createElement('input');
            inputVencimento.type = 'hidden';
            inputVencimento.name = `parcela_${numero}_vencimento`;
            inputVencimento.value = vencimento;

            const inputEmissao = document.createElement('input');
            inputEmissao.type = 'hidden';
            inputEmissao.name = `parcela_${numero}_emissao`;
            inputEmissao.value = emissaoCompleta;

            form.appendChild(inputNumero);
            form.appendChild(inputValor);
            form.appendChild(inputVencimento);
            form.appendChild(inputEmissao);
        });
        console.log('--- Fim da Preparação dos Dados (Frontend) ---');
    });

    btnLimpar.addEventListener('click', function () {
        container.innerHTML = '';
        console.log('Tabela de parcelas limpa.');
    });

    // NOVO BLOCO: Preencher "Nº Parcelas Solicitada" na edição
    {% if num_existing_parcelas %}
        const numExistingParcelas = {{ num_existing_parcelas }};
        const inputNumParcelasSolicitada = document.getElementById('num_parcelas_solicitada');
        if (inputNumParcelasSolicitada) {
            inputNumParcelasSolicitada.value = numExistingParcelas;
            console.log(`Campo "Nº Parcelas Solicitada" preenchido com: ${numExistingParcelas}`);
        }
    {% endif %}
});
</script>
{% endblock %}