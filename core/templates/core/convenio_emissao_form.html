{# core/templates/core/convenio_emissao_form.html #}

{% extends 'core/base.html' %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{{ title }}</h6>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="mb-4">
                <h5 class="text-primary">Dados da Emissão</h5>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="{{ form.CPF.id_for_label }}" class="form-label">CPF/CNPJ do Cliente<span class="text-danger">*</span></label>
                    {% render_field form.CPF class="form-control" placeholder="Digite o CPF/CNPJ" %}
                    <small class="form-text text-muted">Digite o CPF/CNPJ do cliente para buscar seus dados.</small>
                    {% if form.CPF.errors %}
                        {% for error in form.CPF.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                {% render_field form.ID_CLIENTE type="hidden" %}

                <div class="col-md-6 mb-3">
                    <label for="id_nome_cliente_exibicao" class="form-label">Nome do Cliente</label>
                    <input type="text" id="id_nome_cliente_exibicao" class="form-control" readonly placeholder="Preenchido automaticamente">
                </div>

                <div class="col-md-3 mb-3">
                    <label for="{{ form.SALDO.id_for_label }}" class="form-label">Saldo Disponível</label>
                    {% render_field form.SALDO class="form-control" readonly="readonly" placeholder="R$ 0,00" %}
                    {% if form.SALDO.errors %}
                        {% for error in form.SALDO.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                    <div id="saldo-error-feedback" class="invalid-feedback d-block" style="display: none;"></div>
                </div>
            </div>

            <hr>

            <div class="mb-4 mt-4">
                <h5 class="text-primary">Detalhes do Convênio</h5>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.ID_CONVENIO.id_for_label }}" class="form-label">Convênio<span class="text-danger">*</span></label>
                    {% render_field form.ID_CONVENIO class="form-control" %}
                    {% if form.ID_CONVENIO.errors %}
                        {% for error in form.ID_CONVENIO.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    {% endif %}
                </div>

                <div class="col-md-3 mb-3">
                    <label for="{{ form.QTD_PARCELA.id_for_label }}" class="form-label">Quantidade de Parcelas</label>
                    {% render_field form.QTD_PARCELA class="form-control" readonly="readonly" placeholder="Auto" %}
                    {% if form.QTD_PARCELA.errors %}
                        {% for error in form.QTD_PARCELA.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    {% endif %}
                </div>

                <div class="col-md-3 mb-3">
                    <label for="{{ form.VALOR.id_for_label }}" class="form-label">Valor Total da Transação<span class="text-danger">*</span></label>
                    {% render_field form.VALOR class="form-control" placeholder="0,00" %}
                    {% if form.VALOR.errors %}
                        {% for error in form.VALOR.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="{{ form.MES_REFERENCIA.id_for_label }}" class="form-label">Mês de Referência<span class="text-danger">*</span></label>
                    {% render_field form.MES_REFERENCIA class="form-control" placeholder="MM/AAAA" %}
                    <small class="form-text text-muted">Formato: MM/AAAA (Ex: 07/2025)</small>
                    {% if form.MES_REFERENCIA.errors %}
                        {% for error in form.MES_REFERENCIA.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="col-md-3 mb-3">
                    <label for="{{ form.DATA_TRANSACAO.id_for_label }}" class="form-label">Data da Transação<span class="text-danger">*</span></label>
                    {% render_field form.DATA_TRANSACAO class="form-control" %}
                    {% if form.DATA_TRANSACAO.errors %}
                        {% for error in form.DATA_TRANSACAO.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="col-md-3 mb-3">
                    <label for="{{ form.HORA_TRANSACAO.id_for_label }}" class="form-label">Hora da Transação<span class="text-danger">*</span></label>
                    {% render_field form.HORA_TRANSACAO class="form-control" %}
                    {% if form.HORA_TRANSACAO.errors %}
                        {% for error in form.HORA_TRANSACAO.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary me-2" id="saveButton">Salvar</button>
                <a href="{% url 'core:convenio_emissao_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ======== CLIENTE ========
    const cpfInput = document.querySelector('input[name="CPF"]');
    const idClienteInput = document.querySelector('input[name="ID_CLIENTE"]');
    const nomeClienteInput = document.getElementById('id_nome_cliente_exibicao');
    const saldoInput = document.querySelector('input[name="SALDO"]');
    let lastSearchedCpf = '';

    function limparCamposCliente() {
        idClienteInput.value = '';
        nomeClienteInput.value = '';
        saldoInput.value = '';
    }

    async function buscarClientePorCpf(cpf) {
        try {
            const response = await fetch(`/api/clientes/search_by_cpf/?cpf=${encodeURIComponent(cpf)}`);
            if (!response.ok) {
                limparCamposCliente();
                return;
            }
            const data = await response.json();
            idClienteInput.value = data.id || '';
            nomeClienteInput.value = data.nome_completo || '';
            saldoInput.value = data.saldo || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            limparCamposCliente();
        }
    }

    cpfInput.addEventListener('input', function () {
        const cpf = cpfInput.value.replace(/\D/g, '');
        if (cpf.length === 11 && cpf !== lastSearchedCpf) {
            lastSearchedCpf = cpf;
            buscarClientePorCpf(cpf);
        }
        if (cpf.length < 11) {
            limparCamposCliente();
            lastSearchedCpf = '';
        }
    });

    // ======== CONVENIO ========
    const convenioSelect = document.getElementById('{{ form.ID_CONVENIO.id_for_label }}');
    const qtdParcelaInput = document.getElementById('{{ form.QTD_PARCELA.id_for_label }}');

    async function buscarConvenioDetails(idConvenio) {
        try {
            const response = await fetch(`/api/convenios/get_details/?id=${encodeURIComponent(idConvenio)}`);
            if (!response.ok) {
                qtdParcelaInput.value = '';
                return;
            }
            const data = await response.json();
            qtdParcelaInput.value = data.qtd_parc_permi || '';
        } catch (error) {
            console.error('Erro na requisição:', error);
            qtdParcelaInput.value = '';
        }
    }

    convenioSelect.addEventListener('change', function () {
        const idConvenio = convenioSelect.value;
        if (idConvenio) {
            buscarConvenioDetails(idConvenio);
        } else {
            qtdParcelaInput.value = '';
        }
    });

    // ======== MES_REFERENCIA COM CURSOR NO FINAL ========
    const mesRefInput = document.querySelector('input[name="MES_REFERENCIA"]');

    function formatarMesReferencia(valor) {
        const numeros = valor.replace(/\D/g, '').slice(0, 6);
        if (numeros.length <= 2) return numeros;
        return numeros.slice(0,2) + '/' + numeros.slice(2,6);
    }

    if (mesRefInput) {
        mesRefInput.addEventListener('input', function () {
            const valorFormatado = formatarMesReferencia(mesRefInput.value);
            mesRefInput.value = valorFormatado;
            // Força cursor sempre no final
            mesRefInput.setSelectionRange(mesRefInput.value.length, mesRefInput.value.length);
        });
        // Formata ao carregar
        mesRefInput.value = formatarMesReferencia(mesRefInput.value);
    }
});
</script>
{% endblock %}