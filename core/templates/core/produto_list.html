{# core/templates/core/produto_list.html #}
{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Lista de Produtos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Lista de Produtos</h1>
    <a href="{% url 'core:produto_create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Produto
    </a>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Produtos Cadastrados</h6>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por Código EAN/DUN, Descrição..." value="{{ search|default_if_none:'' }}">
            </div>
            <div class="col-md-3">
                <select id="statusFilter" class="form-select">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Todos os Status</option>
                    <option value="A" {% if status_filter == 'A' %}selected{% endif %}>Ativo</option>
                    <option value="I" {% if status_filter == 'I' %}selected{% endif %}>Inativo</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="perPageSelect" class="form-select">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25 por página</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 por página</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 por página</option>
                </select>
            </div>
        </div>

        <div id="produtoTableContainer">
            {% include 'core/produto_table_partial.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const perPageSelect = document.getElementById('perPageSelect');
        const produtoTableContainer = document.getElementById('produtoTableContainer');

        function fetchProdutos(params) {
            const urlParams = new URLSearchParams(params).toString();
            fetch(`{% url 'core:produto_list' %}?${urlParams}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                produtoTableContainer.innerHTML = data.html;
                // Re-inicializa os valores dos selects após a atualização do conteúdo
                if (searchInput) searchInput.value = params.search || '';
                if (statusFilter) statusFilter.value = params.status || 'all';
                if (perPageSelect) perPageSelect.value = params.per_page || 10;
            })
            .catch(error => console.error('Erro ao buscar produtos:', error));
        }

        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter' || this.value.length >= 3 || this.value.length === 0) {
                    fetchProdutos({
                        search: this.value,
                        status: statusFilter ? statusFilter.value : 'all',
                        per_page: perPageSelect ? perPageSelect.value : 10,
                        page: 1
                    });
                }
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                fetchProdutos({
                    search: searchInput ? searchInput.value : '',
                    status: this.value,
                    per_page: perPageSelect ? perPageSelect.value : 10,
                    page: 1
                });
            });
        }

        if (perPageSelect) {
            perPageSelect.addEventListener('change', function() {
                fetchProdutos({
                    search: searchInput ? searchInput.value : '',
                    status: statusFilter ? statusFilter.value : 'all',
                    per_page: this.value,
                    page: 1
                });
            });
        }

        // Delegação de clique para ordenação e paginação
        document.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.sort-link, .page-link')) {
                e.preventDefault();

                const currentSearch = searchInput ? searchInput.value : '';
                const currentStatus = statusFilter ? statusFilter.value : 'all';
                const currentPerPage = perPageSelect ? perPageSelect.value : 10;

                const url = new URL(e.target.href);
                const params = Object.fromEntries(url.searchParams.entries());

                if (currentSearch) params.search = currentSearch;
                if (currentStatus && currentStatus !== 'all') params.status = currentStatus;
                if (currentPerPage) params.per_page = currentPerPage;

                fetchProdutos(params);
            }
        });

        // Define o valor inicial dos selects com base no contexto do Django
        const initialStatus = '{{ status_filter }}';
        if (statusFilter && initialStatus) {
            statusFilter.value = initialStatus;
        }
        const initialPerPage = '{{ per_page }}';
        if (perPageSelect && initialPerPage) {
            perPageSelect.value = initialPerPage;
        }
    });
</script>
{% endblock %}